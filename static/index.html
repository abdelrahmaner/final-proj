<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The Game of Things</title>
    <link rel="stylesheet" href="css/base.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.16/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  </head>
  <body>
    <h1>The Game of Things</h1>
    <div id="content"></div>
    <script type="text/babel">
 
      let Game = React.createClass({
        getInitialState: function() {
          return {gamedata:'', players:'', self: '', submissions: '', joined: false};
        },
        updateGameData: function() {
          if (this.state.joined) {
            $.ajax({
              url: "/data",
              dataType: 'json',
              type: 'POST',
              data: {room: this.state.gamedata.id},
              success: function(data) {
                this.setState({gamedata: data.gamedata, players: data.players, submissions: data.submissions});
                for (var player in data.players) {
                  if (data.players[player].id == this.state.self.id) {
                    this.setState({self: data.players[player]});
                  }
                }
              }.bind(this)
            });
          } else {
            console.log("no room selected");
          }
        },
        componentDidMount: function() {
          this.updateGameData();
          setInterval(this.updateGameData, 2000);
        },
        handleRoomStart: function(data) {
          this.setState({players: data.players, gamedata: data.gamedata, self: data.self, joined: true});
        },
        handleGameStart: function() {
          $.ajax({
            url: "/start",
            dataType: 'json',
            type: 'POST',
            data: {room: this.state.gamedata.id},
          });
        },
        advanceRound: function() {
          $.ajax({
            url: "/advance",
            dataType: 'json',
            type: 'POST',
            data: {room: this.state.gamedata.id},
          });
        },
        render: function() {
          if (this.state.joined) {
            let advanceButton;
            let roomCode = this.state.gamedata.code;
            let playerNodes;
            let numPlayers = 0;
            let isLeader = false;
            let playerScores;
            if (this.state.gamedata.votes == 0 || this.state.gamedata.votes == this.state.gamedata.num_players - 1) {
              let showScore = true;
              playerScores = this.state.players.map(function(player) {
                return (
                  <li key={player.id}><strong>{player.name}</strong> has {player.score} points.</li>
                );
              });
            }
            if (this.state.gamedata.leader.id == this.state.self.id) {
              isLeader = true;
              if (this.state.gamedata.votes == this.state.gamedata.num_players - 1) {
                advanceButton = <button type="button" onClick={this.advanceRound}>Advance Round</button>;
              }
            }
            if (this.state.gamedata.num_round > 0) {
              let submissionForm = <SubmissionForm room={this.state.gamedata.id} self={this.state.self} />;
              let selfId = this.state.self.id;
              let hasVoted = this.state.self.has_voted;
              if (!this.state.gamedata.prompt) {
                submissionForm = '';
              }
              if (this.state.submissions != '') {
                this.state.submissions.map(function(submission) {
                  if (submission.author.id == selfId) {
                    submissionForm = '';
                  }
                });
              }
              let submissionList;
              if (this.state.gamedata.prompt) {
                submissionList = <SubmissionList prompt={this.state.gamedata.prompt} self={this.state.self} submissions={this.state.submissions} num_players={this.state.gamedata.num_players} isLeader={isLeader} />
              }
              return (
                <div>
                  <p>Round {this.state.gamedata.num_round}: The leader of this round is <strong>{isLeader ? "YOU!" : this.state.gamedata.leader.name}</strong></p>
                  <Prompt isLeader={isLeader} prompt={this.state.gamedata.prompt} room={this.state.gamedata.id} />
                  {submissionForm}
                  {submissionList}
                  {advanceButton}
                  <ul>{playerScores}</ul>
                </div>
              );
            }

            if (this.state.players != '') {
              playerNodes = this.state.players.map(function(player) {
                let showScore = false;
                numPlayers++;
                return (
                  <li key={player.id}><strong>{player.name}</strong> has joined.</li>
                );
              });
            }

            let startButton;
            if (this.state.gamedata.owner.id == this.state.self.id) {
              startButton = <p>Are all players ready? Then <button onClick={this.handleGameStart}>Start Game</button></p>;
            } else {
              startButton = '';
            }

            return (
              <div>
                <p id="roomCode">The room code is {roomCode}</p>
                <p id="numPlayers">There are {numPlayers} players.</p>
                <ul id="players">{playerNodes}</ul>
                {startButton}
              </div>
            );
          } else {
            return (<JoinForm onRoomStart={this.handleRoomStart} />);
          }
        }
      });

      let JoinForm = React.createClass({
        getInitialState: function() {
          return {code: '', name: ''};
        },
        handleCodeChange: function(e) {
          this.setState({code: e.target.value});
        },
        handleNameChange: function(e) {
          this.setState({name: e.target.value});
        },
        startRoom: function() {
          $.ajax({
            url: "/connect",
            dataType: 'json',
            type: 'POST',
            data: {name: this.state.name, action: "start"},
            success: function(data) {
              this.props.onRoomStart(data);
            }.bind(this)
          });
        },
        joinRoom: function() {
          $.ajax({
            url: "/connect",
            dataType: 'json',
            type: 'POST',
            data: {name: this.state.name, action: "join", code: this.state.code},
            success: function(data) {
              this.props.onRoomStart(data);
            }.bind(this)
          });
        },
        render: function() {
          return (
            <div>
              <form className="joinRoom">
                <input
                  type="text"
                  placeholder="Enter Your Name"
                  value={this.state.name}
                  onChange={this.handleNameChange}
                  name="name"
                />
                <button type="button" onClick={this.startRoom}>Start Game</button> or <input
                  type="text"
                  placeholder="Room Code"
                  value={this.state.code}
                  onChange={this.handleCodeChange}
                  name="name"
                /><button type="button" onClick={this.joinRoom}>Join Game</button>
              </form>
            </div>
          );
        }
      });

      let Prompt = React.createClass({
        getInitialState: function() {
          return {prompt: ''};
        },
        handlePromptChange: function(e) {
          this.setState({prompt: e.target.value});
        },
        enterPrompt: function() {
          $.ajax({
            url: "/prompt",
            dataType: 'json',
            type: 'POST',
            data: {action: "set", prompt: this.state.prompt, room: this.props.room},
          });
        },
        editPrompt: function() {
          $.ajax({
            url: "/prompt",
            dataType: 'json',
            type: 'POST',
            data: {action: "clear", room: this.props.room}
          });
        },
        render: function() {
          if (this.props.prompt) {
            let editButton;
            if (this.props.isLeader) {
              editButton = <button type="button" onClick={this.editPrompt}>Edit Prompt</button>
            }

            return(<p>The prompt is <strong>"{this.props.prompt}"</strong>{editButton}</p>);
          } else {
            if (this.props.isLeader) {
              return (
                <div>
                  <form className="enterPrompt">
                    <input
                      type="text"
                      placeholder="Enter the Round Prompt"
                      value={this.state.prompt}
                      onChange={this.handlePromptChange}
                      name="prompt"
                    />
                    <button type="button" onClick={this.enterPrompt}>Enter Prompt</button>
                  </form>
                </div>
              );
            } else {
              return(<p>The prompt has not yet been entered.</p>);
            }
          }
        }
      });

      let SubmissionForm = React.createClass({
        getInitialState: function() {
          return {submission: ''};
        },
        handleSubmissionChange: function(e) {
          this.setState({submission: e.target.value});
        },
        addSubmission: function() {
          $.ajax({
            url: "/submit",
            dataType: 'json',
            type: 'POST',
            data: {submission: this.state.submission, self: this.props.self.id, room: this.props.room}
          });
        },
        render: function() {
          return (
            <div>
              <form className="addSubmission">
                <input
                  type="text"
                  placeholder="Enter Your Answer to the Prompt"
                  value={this.state.submission}
                  onChange={this.handleSubmissionChange}
                  name="submission"
                />
                <button type="button" onClick={this.addSubmission}>Enter Submission</button>
              </form>
            </div>
          );
        }
      });

      let SubmissionList = React.createClass({
        render: function() {
          let submissionNodes;
          let prompt = this.props.prompt
          let isLeader = this.props.isLeader;
          let player = this.props.self;
          if (this.props.submissions != '') {
            if (this.props.submissions.length == this.props.num_players) {
              submissionNodes = this.props.submissions.map(function(submission) {
                return (
                  <Submission author={submission.author} isLeader={isLeader} prompt={prompt} key={submission.id} self={player} votes={submission.votes} submission={submission.id} text={submission.text} showAuth={submission.show_auth} isLeader={isLeader} />
                );
              });
            } else {
                if (this.props.submissions.length == 1) {
                  return (
                    <li>1 person has submitted.</li>
                  )
                } else {
                  return (
                    <li>{this.props.submissions.length} people have submitted.</li>
                  );
              }
            }
           
          } else {
            submissionNodes = <li>No one has submitted yet.</li>;
          }

          return (<ul>{submissionNodes}</ul>);
        }
      });

      let Submission = React.createClass({
        revealSubmission: function() {
          $.ajax({
            url: "/reveal",
            dataType: 'json',
            type: 'POST',
            data: {submission: this.props.submission}
          });
        },
        voteOnSubmission: function() {
          $.ajax({
            url: "/vote",
            dataType: 'json',
            type: 'POST',
            data: {submission: this.props.submission, player: this.props.self.id}
          });
        },
        render: function() {
          let author;
        let voteButton;
        if (!this.props.self.has_voted && this.props.author.id != this.props.self.id && !this.props.isLeader) {
          voteButton = <button type="button" onClick={this.voteOnSubmission}>Vote for this Submission</button>;
        }
          if (this.props.showAuth) {
            author = <span> - {this.props.author.name}</span>;
          }
          return (
            <li className="submission">
              <strong>{this.props.prompt}</strong> {this.props.text} - Votes: {this.props.votes}{author}{voteButton}
            </li>
          );
        }
      });

      ReactDOM.render(
        <Game />,
        document.getElementById('content')
      );
    </script>
  </body>
</html>
